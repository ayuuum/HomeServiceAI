

# LINE AI自動応答の修正計画

## 問題の原因

現在の実装では、カスタムシステムプロンプト（「明るく元気な言葉遣いで」）が設定されると、サービス情報を含むデフォルトプロンプトが**完全に上書き**されてしまいます。その結果、AIはお店のサービスについて何も知らない状態で回答してしまいました。

```text
現在の動作:
┌─────────────────────────────────────────┐
│ カスタムプロンプトあり？                 │
│   → YES → カスタムのみ使用（サービス情報なし）❌
│   → NO  → デフォルト使用（サービス情報あり）✓
└─────────────────────────────────────────┘

修正後の動作:
┌─────────────────────────────────────────┐
│ 常にサービス情報を含むデフォルトを使用   │
│   + カスタムプロンプトは「追加指示」として │
│     デフォルトに追記される                │
└─────────────────────────────────────────┘
```

---

## 修正内容

### 1. Edge Function (`line-ai-agent/index.ts`) の修正

カスタムプロンプトをデフォルトプロンプトに**追加**する形に変更します：

**変更前（問題のコード）:**
```typescript
const finalSystemPrompt = systemPrompt || defaultSystemPrompt;
```

**変更後:**
```typescript
let finalSystemPrompt = defaultSystemPrompt;

// カスタムプロンプトがある場合は追加指示として組み込む
if (systemPrompt && systemPrompt.trim()) {
  finalSystemPrompt = `${defaultSystemPrompt}

【追加指示】
${systemPrompt}`;
}
```

---

### 2. デフォルトプロンプトの強化

サービス情報を基にした回答を**必須**とする指示を追加：

```typescript
const defaultSystemPrompt = `あなたは「${orgInfo.name}」の専属AIアシスタントです。
ハウスクリーニングサービスを提供するお店のスタッフとして、お客様のLINEメッセージに対応してください。

【重要な役割】
- あなたはこのお店の代表として回答します
- 一般的なAIアシスタントではありません
- サービスや料金の質問には、以下の情報を基に具体的に回答してください

【対応方針】
- 明るく丁寧な敬語で対応する
- サービスの質問には以下の【利用可能なサービス情報】から回答する
- 予約希望の場合は予約ページへ案内する
- 長すぎる返答は避け、簡潔にまとめる（最大300文字程度）
- 不明な点は「担当スタッフに確認いたします」と伝える

【利用可能なサービス情報】
${serviceInfo}

${conversationHistory}`;
```

---

### 3. UI (`LineSettingsForm.tsx`) の説明文を更新

ユーザーが誤解しないよう、カスタムプロンプトの役割を明確にします：

**変更前:**
```tsx
<Label>カスタムシステムプロンプト（オプション）</Label>
```

**変更後:**
```tsx
<Label>AI応答スタイルの追加指示（オプション）</Label>
<p className="text-xs text-muted-foreground">
  AIの応答スタイルを調整するための追加指示です。
  サービス情報は自動的に含まれます。
  例：「フレンドリーな口調で」「敬語を厳密に」
</p>
```

---

## 修正後の期待動作

**お客様**: 「どんなサービスがある？」

**AI応答（修正後）:**
```
お問い合わせありがとうございます！✨

当店では以下のサービスをご用意しております：

【エアコンクリーニング】
料金: ¥12,000〜
所要時間: 約90分

【バスルームクリーニング】
料金: ¥15,000〜
所要時間: 約120分

【キッチン水回りクリーニング】
料金: ¥18,000〜
所要時間: 約120分

ご興味のあるサービスがございましたら、お気軽にお申し付けください！
```

---

## 技術的な変更ファイル

| ファイル | 変更内容 |
|----------|---------|
| `supabase/functions/line-ai-agent/index.ts` | カスタムプロンプトを追加指示として扱うよう修正、デフォルトプロンプトを強化 |
| `src/components/LineSettingsForm.tsx` | カスタムプロンプト欄の説明文を更新 |

---

## 動作確認項目

修正完了後、以下を確認してください：

1. 「どんなサービスがある？」に対して、実際のサービス情報（エアコン、バスルーム等）が回答される
2. 「料金はいくら？」に対して、具体的な金額が回答される
3. 「明るく元気な言葉遣いで」の追加指示が反映され、フレンドリーなトーンで回答される

