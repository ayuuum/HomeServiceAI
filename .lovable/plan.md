

# クロスサービスセット割引機能の実装プラン

## 概要

異なるサービスを組み合わせて予約すると自動的に割引が適用される「セット割」機能を実装します。例：「エアコン + 浴室クリーニングで10%OFF」。管理者がセット割を自由に設定でき、予約フォームで自動適用＆提案表示されます。

---

## UIイメージ

### 管理画面（セット割設定）

```text
┌─────────────────────────────────────────┐
│ セット割引の管理                          │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 水回りセット割         10% OFF      │ │
│ │ エアコン + 浴室クリーニング         │ │
│ │                    [編集] [削除]    │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [+ 新しいセット割を追加]                 │
└─────────────────────────────────────────┘
```

### 予約フォーム（顧客向け）

Step 1 で複数サービス選択時にバッジ表示：

```text
┌─────────────────────────────────────────┐
│ 🎉 セット割が適用されます！              │
│ 「水回りセット割」 -¥3,200（10%OFF）    │
└─────────────────────────────────────────┘
```

Step 4 確認画面の合計金額にも割引内訳として表示。

---

## 実装内容

### Phase 1: データベース

`organizations` テーブルに `service_set_discounts` (JSONB) カラムを追加。

```text
service_set_discounts の構造:
[
  {
    "id": "uuid",
    "title": "水回りセット割",
    "service_ids": ["service_a_id", "service_b_id"],
    "discount_rate": 0.10,
    "description": "エアコンと浴室の同時予約で10%OFF"
  }
]
```

新しいテーブルは不要。JSOBNカラム1つで管理できます。

### Phase 2: 割引計算ロジック

`src/lib/discountCalculator.ts` にセット割引の計算関数を追加：

- 選択中のサービスIDリストと定義済みセット割を照合
- 条件を満たすセットの中から最も有利な割引を自動適用
- 既存の数量割引と併用可能（数量割引後の金額にセット割を適用）

### Phase 3: 管理画面UI

`ProfilePage.tsx` の設定画面にセット割引管理セクションを追加：

- サービス一覧からチェックボックスで複数選択
- 割引率（%）を入力
- セット名・説明を入力
- 作成/編集/削除操作

### Phase 4: 予約フォーム統合

- `useBooking.ts` の価格計算ロジックを拡張してセット割を反映
- Step 1: セット割対象サービスを選択した際にバッジで通知
- Step 4: 確認画面の金額内訳にセット割引を表示
- `BookingUpsellSection.tsx` を拡張：「あと○○を追加するとセット割が適用されます」

---

## 技術的な変更

| ファイル | 変更内容 |
|----------|---------|
| DBマイグレーション | `organizations` に `service_set_discounts` JSONB カラム追加 |
| `src/lib/discountCalculator.ts` | `calculateSetDiscount` 関数を追加 |
| `src/hooks/useBooking.ts` | 価格計算にセット割引を統合 |
| `src/components/booking/BookingUpsellSection.tsx` | セット割提案の表示を追加 |
| `src/components/booking/SetDiscountBadge.tsx` | 新規 - 適用中セット割の表示バッジ |
| `src/components/admin/SetDiscountManager.tsx` | 新規 - 管理画面のセット割設定UI |
| `src/pages/ProfilePage.tsx` | セット割管理セクションを追加 |

### 価格計算の流れ

```text
1. サービス基本料金 x 数量
2. 数量割引を適用（既存ロジック）
3. オプション料金を加算
4. セット割引を適用（新規）★
5. 合計金額を表示
```

### セット割の判定ロジック

```text
選択中サービスIDs = [A, B, C]
定義済みセット = [{service_ids: [A, B], rate: 0.10}, {service_ids: [B, C], rate: 0.05}]

→ [A, B] が全て含まれる → 10%OFF 適用
→ [B, C] も全て含まれる → 5%OFF も適用（複数セット併用可）
```

