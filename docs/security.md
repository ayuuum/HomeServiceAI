# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»èªè¨¼ãƒ»ã‚¤ãƒ³ãƒ•ãƒ© ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Haukuri Proã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã€èªè¨¼æ–¹å¼ã€ãŠã‚ˆã³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

---

## æ¦‚è¦

Haukuri Proã¯ã€**ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã‚’æ¡ç”¨ã—ãŸãƒ¢ãƒ€ãƒ³ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å¾“æ¥ã®ã‚ˆã†ã«ã‚µãƒ¼ãƒãƒ¼ã‚’è‡ªå‰ã§é‹ç”¨ã™ã‚‹ã®ã§ã¯ãªãã€Supabaseã¨ã„ã†ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆBaaSï¼‰ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ã®æ‰‹é–“ã‚’æœ€å°é™ã«æŠ‘ãˆãªãŒã‚‰ã€é«˜ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æ‹¡å¼µæ€§ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

### ãªãœã“ã®æ§‹æˆãªã®ã‹ï¼Ÿ

1. **é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ãšã«ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãŸã‚ã€é–‹ç™ºåŠ¹ç‡ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚
2. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: SupabaseãŒã‚¤ãƒ³ãƒ•ãƒ©ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ãŒå¢—ãˆã¦ã‚‚è‡ªå‹•çš„ã«ã‚¹ã‚±ãƒ¼ãƒ«ã—ã¾ã™ã€‚
3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Row Level Securityï¼ˆRLSï¼‰ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†ãŸã‚ã€APIã«è„†å¼±æ€§ãŒã‚ã£ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã®ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã§ãã¾ã™ã€‚
4. **ã‚³ã‚¹ãƒˆåŠ¹ç‡**: å¾“é‡èª²é‡‘ãƒ¢ãƒ‡ãƒ«ã®ãŸã‚ã€å°è¦æ¨¡ãªã†ã¡ã¯ä½ã‚³ã‚¹ãƒˆã§é‹ç”¨ã§ãã€æˆé•·ã«åˆã‚ã›ã¦æ‹¡å¼µã§ãã¾ã™ã€‚

---

## ğŸ“ ã‚¤ãƒ³ãƒ•ãƒ© ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
graph TD
    subgraph Client["ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰"]
        User[ãƒ¦ãƒ¼ã‚¶ãƒ¼ / ç®¡ç†è€…]
    end

    subgraph Frontend["ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)"]
        Vite[Vite + React SPA]
        AuthContext[AuthContext]
        SupabaseClient[Supabase Client]
    end

    subgraph Backend["ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Supabase)"]
        SupaAuth[Supabase Auth]
        PostgreSQL[(PostgreSQL + RLS)]
        Storage[Storage]
        Realtime[Realtime]
        EdgeFunctions[Edge Functions]
    end

    subgraph External["å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹"]
        LINE[LINE Platform]
    end

    User --> Vite
    Vite --> SupabaseClient
    SupabaseClient <--> SupaAuth
    SupabaseClient <--> PostgreSQL
    SupabaseClient <--> Storage
    SupabaseClient <--> Realtime
    EdgeFunctions <--> LINE
```

ä¸Šè¨˜ã®å›³ãŒç¤ºã™ã‚ˆã†ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰Vercelã«ãƒ›ã‚¹ãƒˆã•ã‚ŒãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReact SPAï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãã“ã‹ã‚‰Supabaseã®å„ã‚µãƒ¼ãƒ“ã‚¹ã¨é€šä¿¡ã—ã¾ã™ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é–“ã«ç‹¬è‡ªã®APIã‚µãƒ¼ãƒãƒ¼ã¯å­˜åœ¨ã›ãšã€Supabase Clientãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é€šã˜ã¦ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ§‹æˆã§ã™ã€‚

ã“ã®æ§‹æˆã®ç‰¹å¾´ã¯ã€**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’é›†ä¸­ã•ã›ã¤ã¤ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§æ‹…ä¿ã™ã‚‹**ã¨ã„ã†ç‚¹ã§ã™ã€‚å¾“æ¥ã®ã€ŒAPIã‚µãƒ¼ãƒãƒ¼ã§èªå¯ãƒã‚§ãƒƒã‚¯ã€ã¨ã„ã†æ–¹å¼ã¨ã¯ç•°ãªã‚Šã€PostgreSQLã®Row Level Securityï¼ˆRLSï¼‰æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦ã€ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§é®æ–­ã—ã¾ã™ã€‚

### ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°æ§‹æˆ

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ | ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚° |
|----------|------|-------------|
| **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰** | React + Vite + TypeScript | **Vercel** (æ¨å¥¨) |
| **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰** | Supabase (BaaS) | **Supabase Cloud** |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | PostgreSQL | Supabase managed |
| **ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°** | Supabase Edge Functions (Deno) | Supabase managed |

Vercelã¯é™çš„ã‚µã‚¤ãƒˆã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã«ç‰¹åŒ–ã—ãŸãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã€GitHubã¨é€£æºã™ã‚‹ã“ã¨ã§ãƒ—ãƒƒã‚·ãƒ¥ã®ãŸã³ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚Supabaseã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€èªè¨¼ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ã§æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ã©ã¡ã‚‰ã‚‚ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã®é‹ç”¨ä¿å®ˆã¯ä¸è¦ã§ã™ã€‚

---

## ğŸ” èªè¨¼ (Authentication)

èªè¨¼ã¨ã¯ã€ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª°ãªã®ã‹ã€ã‚’ç¢ºèªã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚Haukuri Proã§ã¯**Supabase Auth**ã¨ã„ã†èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯Googleã‚„Facebookãªã©ã®å¤§æ‰‹ã‚µãƒ¼ãƒ“ã‚¹ã¨åŒæ§˜ã®OAuth2/JWTæ–¹å¼ã‚’æ¡ç”¨ã—ã¦ãŠã‚Šã€æ¥­ç•Œæ¨™æº–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã‚’æä¾›ã—ã¾ã™ã€‚

èªè¨¼çŠ¶æ…‹ã®ç®¡ç†ã¯ `src/contexts/AuthContext.tsx` ã§è¡Œã£ã¦ãŠã‚Šã€ã‚¢ãƒ—ãƒªå…¨ä½“ã§ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’å…±æœ‰ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

### å¯¾å¿œèªè¨¼æ–¹å¼

| èªè¨¼æ–¹å¼ | å®Ÿè£…çŠ¶æ³ | å®Ÿè£…ç®‡æ‰€ |
|----------|----------|----------|
| **Email/Password** | âœ… å®Ÿè£…æ¸ˆã¿ | `supabase.auth.signInWithPassword` |
| **Google OAuth** | âœ… å®Ÿè£…æ¸ˆã¿ | `supabase.auth.signInWithOAuth({ provider: 'google' })` |
| **LINE OAuth** | ğŸ“‹ è¨ˆç”»ä¸­ | PRDã«è¨˜è¼‰ |
| **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ** | âœ… å®Ÿè£…æ¸ˆã¿ | Supabase Auth æ¨™æº–æ©Ÿèƒ½ |

**Email/Passwordèªè¨¼**ã¯å¾“æ¥å‹ã®ãƒ­ã‚°ã‚¤ãƒ³æ–¹å¼ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚**Google OAuth**ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹æ–¹å¼ã§ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ã®æ‰‹é–“ãŒãªããƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒå‘ä¸Šã—ã¾ã™ã€‚

### èªè¨¼ãƒ•ãƒ­ãƒ¼

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®æµã‚Œã§èªè¨¼ãŒè¡Œã‚ã‚Œã¾ã™ï¼š

1. **ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼æƒ…å ±ï¼ˆãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ or Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰ã‚’é€ä¿¡
2. **ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ**: Supabase AuthãŒèªè¨¼æƒ…å ±ã‚’æ¤œè¨¼ã—ã€æ­£ã—ã‘ã‚Œã°JWTï¼ˆJSON Web Tokenï¼‰ã‚’ç™ºè¡Œ
3. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜**: JWTã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã®`localStorage`ã«ä¿å­˜ã—ã€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¶­æŒ
4. **è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥**: JWTã®æœ‰åŠ¹æœŸé™ãŒè¿‘ã¥ãã¨ã€è‡ªå‹•çš„ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
5. **çµ„ç¹”æƒ…å ±å–å¾—**: ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€`AuthContext`ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€å±çµ„ç¹”ï¼ˆ`organization_id`ï¼‰ã‚’å–å¾—ã—ã€é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ç¯„å›²ã‚’è¨­å®š

ã“ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒå¾©å…ƒã•ã‚Œã¾ã™ã€‚

### Supabase Edge Functions

Edge Functionsã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹å‡¦ç†ï¼ˆå¤–éƒ¨APIã¨ã®é€£æºãªã©ï¼‰ã‚’æ‹…å½“ã—ã¾ã™ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã›ãªã„APIã‚­ãƒ¼ã‚’ä½¿ã†å‡¦ç†ã‚„ã€Webhookï¼ˆå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®é€šçŸ¥å—ä¿¡ï¼‰ã®å‡¦ç†ã«ä½¿ç”¨ã—ã¾ã™ã€‚

| é–¢æ•°å | ç”¨é€” |
|--------|------|
| `line-webhook` | LINEã‹ã‚‰ã®Webhookï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãªã©ï¼‰ã‚’å‡¦ç† |
| `send-line-message` | LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ |
| `booking-assistant` | äºˆç´„ã«é–¢ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆæ©Ÿèƒ½ |

---

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ - Row Level Security (RLS)

### RLSã¨ã¯ä½•ã‹ï¼Ÿ

Row Level Securityï¼ˆè¡Œãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰ã¯ã€**PostgreSQLã®çµ„ã¿è¾¼ã¿æ©Ÿèƒ½**ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®å„è¡Œã«å¯¾ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†ä»•çµ„ã¿ã§ã™ã€‚

å¾“æ¥ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€APIã‚µãƒ¼ãƒãƒ¼å´ã§ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã„ã‹ï¼Ÿã€ã‚’åˆ¤å®šã—ã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€APIã«è„†å¼±æ€§ï¼ˆãƒã‚°ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ›ãƒ¼ãƒ«ï¼‰ãŒã‚ã‚‹ã¨ã€ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

RLSã¯**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†**ãŸã‚ã€ãŸã¨ãˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚„APIã«å•é¡ŒãŒã‚ã£ã¦ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæœ€å¾Œã®ç ¦ã¨ã—ã¦ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ãã¾ã™ã€‚ã“ã‚Œã¯ã€Œæ·±å±¤é˜²å¾¡ï¼ˆDefense in Depthï¼‰ã€ã®è€ƒãˆæ–¹ã«åŸºã¥ã„ãŸè¨­è¨ˆã§ã™ã€‚

### ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã¨ã¯ï¼Ÿ

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯**ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã¨ã¯ã€1ã¤ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§è¤‡æ•°ã®çµ„ç¹”ï¼ˆä¼šç¤¾ãƒ»åº—èˆ—ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹æ–¹å¼ã§ã™ã€‚

ä¾‹ãˆã°ã€ãƒã‚¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ä¼šç¤¾Aã¨ä¼šç¤¾BãŒåŒã˜Haukuri Proã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã€ãŠäº’ã„ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚„äºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯çµ¶å¯¾ã«è¦‹ãˆã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚ã“ã®ã€Œãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã€ã‚’RLSã§å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

### ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã®ä»•çµ„ã¿

- å„ãƒ†ãƒ¼ãƒ–ãƒ«ã« `organization_id` ã‚«ãƒ©ãƒ ã‚’è¨­ç½®ã—ã€ã©ã®çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚’è­˜åˆ¥
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ `profiles` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é€šã˜ã¦æ‰€å±çµ„ç¹”ã«ç´ä»˜ã‘
- RLSãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®æ‰€å±çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

### ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãƒãƒªã‚·ãƒ¼ä¸€è¦§

#### organizations ãƒ†ãƒ¼ãƒ–ãƒ«

| ãƒãƒªã‚·ãƒ¼å | æ“ä½œ | æ¡ä»¶ |
|-----------|------|------|
| Users can view own organization | SELECT | è‡ªåˆ†ã®æ‰€å±çµ„ç¹”ã®ã¿ |

#### profiles ãƒ†ãƒ¼ãƒ–ãƒ«

| ãƒãƒªã‚·ãƒ¼å | æ“ä½œ | æ¡ä»¶ |
|-----------|------|------|
| Users can view profiles in own organization | SELECT | åŒä¸€çµ„ç¹” or è‡ªåˆ†è‡ªèº« |

#### customers ãƒ†ãƒ¼ãƒ–ãƒ«

| ãƒãƒªã‚·ãƒ¼å | æ“ä½œ | æ¡ä»¶ |
|-----------|------|------|
| Users can view own org customers | SELECT | åŒä¸€çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| Users can create customers for own org | INSERT | åŒä¸€çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| Users can update own org customers | UPDATE | åŒä¸€çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| Users can delete own org customers | DELETE | åŒä¸€çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| Anyone can create customers with org | INSERT | å…¬é–‹äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ç”¨ |

#### bookings ãƒ†ãƒ¼ãƒ–ãƒ«

| ãƒãƒªã‚·ãƒ¼å | æ“ä½œ | æ¡ä»¶ |
|-----------|------|------|
| Users can view own org bookings | SELECT | åŒä¸€çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| Users can create bookings for own org | INSERT | åŒä¸€çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| Users can update own org bookings | UPDATE | åŒä¸€çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| Users can delete own org bookings | DELETE | åŒä¸€çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ |
| Public can create bookings | INSERT | å…¬é–‹äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ç”¨ï¼ˆèª°ã§ã‚‚å¯ï¼‰ |

#### services / service_options ãƒ†ãƒ¼ãƒ–ãƒ«

| ãƒãƒªã‚·ãƒ¼å | æ“ä½œ | æ¡ä»¶ |
|-----------|------|------|
| Anyone can view services | SELECT | å…¬é–‹ï¼ˆäºˆç´„ãƒšãƒ¼ã‚¸è¡¨ç¤ºç”¨ï¼‰ |
| Users can manage own org services | ALL | ç·¨é›†ã¯åŒä¸€çµ„ç¹”ã®ã¿ |

### RLSãƒãƒªã‚·ãƒ¼ã®å®Ÿè£…ä¾‹

ä»¥ä¸‹ã¯ã€é¡§å®¢ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã™ã‚‹RLSãƒãƒªã‚·ãƒ¼ã®ä¾‹ã§ã™ã€‚ã“ã®ãƒãƒªã‚·ãƒ¼ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®æ‰€å±çµ„ç¹”ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®ã¿é–²è¦§ã§ãã‚‹ã€ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```sql
-- customers ãƒ†ãƒ¼ãƒ–ãƒ«ã®SELECTãƒãƒªã‚·ãƒ¼ä¾‹
CREATE POLICY "Users can view own org customers"
  ON public.customers FOR SELECT
  USING (
    organization_id IN (
      SELECT organization_id FROM public.profiles WHERE id = auth.uid()
    )
  );
```

ã“ã®SQLã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å‹•ä½œã—ã¾ã™ï¼š

1. `auth.uid()` ã§ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
2. `profiles`ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®`organization_id`ã‚’å–å¾—
3. `customers`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å„è¡Œã«ã¤ã„ã¦ã€`organization_id`ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã®ã¿è¿”ã™

ã“ã®ãƒ«ãƒ¼ãƒ«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§å¼·åˆ¶ã•ã‚Œã‚‹ãŸã‚ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã§ã©ã‚“ãªã‚¯ã‚¨ãƒªã‚’æ›¸ã„ã¦ã‚‚ã€ä»–ã®çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã¯ç‰©ç†çš„ã«ä¸å¯èƒ½ã§ã™ã€‚

---

## ğŸ”‘ ç’°å¢ƒå¤‰æ•°

ç’°å¢ƒå¤‰æ•°ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ä½œã™ã‚‹ãŸã‚ã«å¿…è¦ãªè¨­å®šå€¤ã‚’å¤–éƒ¨ã‹ã‚‰æ³¨å…¥ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚æœ¬ç•ªç’°å¢ƒã¨é–‹ç™ºç’°å¢ƒã§ç•°ãªã‚‹å€¤ã‚’ä½¿ã„ãŸã„å ´åˆï¼ˆä¾‹ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¥ç¶šå…ˆï¼‰ã«ä¾¿åˆ©ã§ã™ã€‚

| å¤‰æ•°å | ç”¨é€” | å…¬é–‹å¯å¦ |
|--------|------|----------|
| `VITE_SUPABASE_URL` | Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL | âœ… å…¬é–‹å¯ |
| `VITE_SUPABASE_PUBLISHABLE_KEY` | Supabase Anon Key | âœ… å…¬é–‹å¯ (RLSã§ä¿è­·) |
| `VITE_SUPABASE_PROJECT_ID` | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­ | âœ… å…¬é–‹å¯ |

### ãªãœAnon Keyã‚’å…¬é–‹ã—ã¦ã‚‚å®‰å…¨ãªã®ã‹ï¼Ÿ

ã€ŒAPIã‚­ãƒ¼ã‚’å…¬é–‹ã—ã¦å¤§ä¸ˆå¤«ãªã®ï¼Ÿã€ã¨ç–‘å•ã«æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚Supabaseã«ã¯2ç¨®é¡ã®ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã™ï¼š

1. **Anon Keyï¼ˆå…¬é–‹ã‚­ãƒ¼ï¼‰**: ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ã€‚RLSãŒæœ‰åŠ¹ãªå ´åˆã€ã“ã®ã‚­ãƒ¼ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã¯RLSãƒãƒªã‚·ãƒ¼ã§åˆ¶é™ã•ã‚Œã‚‹
2. **Service Role Keyï¼ˆç§˜å¯†ã‚­ãƒ¼ï¼‰**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ã¿ä½¿ç”¨ã€‚RLSã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ãã‚‹ãŸã‚ã€çµ¶å¯¾ã«å…¬é–‹ã—ã¦ã¯ã„ã‘ãªã„

`VITE_` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒã¤ã„ãŸç’°å¢ƒå¤‰æ•°ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ“ãƒ«ãƒ‰æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰è¦‹ãˆã¾ã™ã€‚Anon Keyã¯ã“ã®ç›®çš„ã§è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å…¬é–‹ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚**ãŸã ã—ã€Service Role Keyã¯çµ¶å¯¾ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚**

---

## âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

| é …ç›® | çŠ¶æ…‹ | è©³ç´° |
|------|------|------|
| **èªè¨¼åŸºç›¤** | âœ… è‰¯å¥½ | Supabase Auth (æ¥­ç•Œæ¨™æº–OAuth2/JWT) |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†** | âœ… è‰¯å¥½ | ãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•æ›´æ–°ãƒ»æ°¸ç¶šåŒ– |
| **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ (RLS)** | âœ… è‰¯å¥½ | organization_id ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ |
| **å…¬é–‹APIã®åˆ¶é™** | âœ… è‰¯å¥½ | SELECT ã¯å…¬é–‹ã€CRUD ã¯èªè¨¼å¿…é ˆ |
| **HTTPS** | âœ… è‡ªå‹• | Vercel/Supabase æ¨™æº–ã§å¼·åˆ¶ |
| **CORS** | âœ… è‡ªå‹• | Supabase ã§è¨­å®šæ¸ˆã¿ |

---

## âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹æ³¨æ„äº‹é …

é–‹ç™ºãƒ»é‹ç”¨æ™‚ã«æ°—ã‚’ã¤ã‘ã‚‹ã¹ãã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ³¨æ„ç‚¹ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

### 1. `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†

`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯Supabaseã®æ¥ç¶šæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯`.gitignore`ã«è¿½åŠ ã—ã€GitHubã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ã€‚ä¸‡ãŒä¸€ã‚³ãƒŸãƒƒãƒˆã—ãŸå ´åˆã¯ã€Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã‚­ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚

### 2. Service Role Keyã®å–ã‚Šæ‰±ã„

Service Role Keyã¯RLSã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ãã‚‹å¼·åŠ›ãªã‚­ãƒ¼ã§ã™ã€‚ã“ã‚Œã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã«å«ã‚ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹çŠ¶æ…‹ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã®ã‚­ãƒ¼ã¯Edge Functionsãªã©ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

### 3. æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæ™‚ã®RLSè¨­å®š

æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹éš›ã¯ã€å¿…ãšä»¥ä¸‹ã®æ‰‹é †ã‚’è¸ã‚“ã§ãã ã•ã„ï¼š

1. `ALTER TABLE ãƒ†ãƒ¼ãƒ–ãƒ«å ENABLE ROW LEVEL SECURITY;` ã§RLSã‚’æœ‰åŠ¹åŒ–
2. é©åˆ‡ãªRLSãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯èª°ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„çŠ¶æ…‹ï¼‰
3. ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å‹•ä½œç¢ºèª

RLSã‚’æœ‰åŠ¹åŒ–ã—å¿˜ã‚Œã‚‹ã¨ã€ãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

### 4. å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã€ŒDatabase > Policiesã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã€ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãƒãƒªã‚·ãƒ¼ã‚’å®šæœŸçš„ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚æ„å›³ã—ãªã„ãƒãƒªã‚·ãƒ¼ï¼ˆä¾‹ï¼š`USING (true)` ã§å…¨è¨±å¯ï¼‰ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ã€‚

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³](./architecture.md)
- [ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰](./deployment.md)
- [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](./tech_stack.md)
- [LINEé€£æºè¨­å®šã‚¬ã‚¤ãƒ‰](./line_integration_guide.md)
