# LINE予約システム 実装アーキテクチャ図解

## 📐 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                         ユーザー側                               │
└─────────────────────────────────────────────────────────────────┘

    Web予約                              LINE予約

┌──────────────┐                    ┌──────────────┐
│   ブラウザ   │                    │  LINEアプリ  │
│              │                    │              │
│  Chrome/     │                    │ リッチメニュー│
│  Safari      │                    │ ┌──────────┐ │
│              │                    │ │予約する🗓️│ │
└──────┬───────┘                    │ └─────┬────┘ │
       │                            └───────┼──────┘
       │ https://domain.com/               │
       │ booking/salon-a                   │ タップ
       │                                   │
       ▼                                   ▼
┌──────────────────────────────────────────────────────────────────┐
│                      フロントエンド (React)                       │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  /src/pages/                      /src/pages/liff/               │
│  BookingPage.tsx                  LiffBookingPage.tsx            │
│  ┌─────────────────┐              ┌──────────────────┐          │
│  │                 │              │ 1. LIFF初期化     │          │
│  │ 通常の予約フロー│              │    liff.init()    │          │
│  │                 │              │                   │          │
│  │                 │              │ 2. ログイン確認   │          │
│  │                 │              │    isLoggedIn()   │          │
│  │                 │              │                   │          │
│  │                 │              │ 3. プロフィール   │          │
│  │                 │              │    getProfile()   │          │
│  │                 │              │    ┌──────────┐  │          │
│  │                 │              │    │userId    │  │          │
│  │                 │              │    │displayName│ │          │
│  │                 │              │    │pictureUrl│  │          │
│  │                 │              │    └──────────┘  │          │
│  │                 │              │                   │          │
│  │                 │              │ 4. 顧客情報取得   │          │
│  │                 │              │    ↓              │          │
│  └─────────────────┘              └──────┬───────────┘          │
│           │                              │                       │
│           └──────────┬───────────────────┘                       │
│                      ▼                                           │
│         ┌────────────────────────────┐                          │
│         │ 共通予約コンポーネント      │                          │
│         ├────────────────────────────┤                          │
│         │ BookingServiceSelection    │  Step 1: サービス選択    │
│         │ BookingDateTimeSelection   │  Step 2: 日時選択        │
│         │ BookingCustomerForm        │  Step 3: 顧客情報        │
│         │ BookingConfirmation        │  Step 4: 確認・送信      │
│         └────────────┬───────────────┘                          │
│                      │                                           │
└──────────────────────┼───────────────────────────────────────────┘
                       │
                       │ POST /bookings
                       ▼
┌──────────────────────────────────────────────────────────────────┐
│                    バックエンド (Supabase)                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  PostgreSQL Database                                              │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                                                           │   │
│  │  customers テーブル                                       │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ id                                               │    │   │
│  │  │ name                                             │    │   │
│  │  │ email                                            │    │   │
│  │  │ phone                                            │    │   │
│  │  │ line_user_id  ← LINEユーザーはここが埋まる      │    │   │
│  │  │ organization_id                                  │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                           │   │
│  │  bookings テーブル                                        │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ id                                               │    │   │
│  │  │ customer_id  ← Web/LINE共通                     │    │   │
│  │  │ customer_name                                    │    │   │
│  │  │ selected_date                                    │    │   │
│  │  │ selected_time                                    │    │   │
│  │  │ total_price                                      │    │   │
│  │  │ status                                           │    │   │
│  │  │ organization_id                                  │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
│  Edge Functions                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ send-hybrid-notification                                 │   │
│  │  ├─ メール送信 (Resend)                                  │   │
│  │  └─ LINE送信 (Messaging API)                            │   │
│  └──────────────────────────────────────────────────────────┘   │
│                      │                                           │
└──────────────────────┼───────────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────────┐
│                    LINE Platform                                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  LINE Messaging API                                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                                                           │   │
│  │  Push Message                                            │   │
│  │  ┌─────────────────────────────────────────┐            │   │
│  │  │ 予約完了 ✅                              │            │   │
│  │  │                                          │            │   │
│  │  │ 山田太郎 様                              │            │   │
│  │  │ ご予約ありがとうございます               │            │   │
│  │  │                                          │            │   │
│  │  │ 日時: 2024/03/15 14:00                  │            │   │
│  │  │ サービス: カット                         │            │   │
│  │  │ 料金: ¥5,000                            │            │   │
│  │  │                                          │            │   │
│  │  │ [予約詳細を見る] [日程を変更する]        │            │   │
│  │  └─────────────────────────────────────────┘            │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

---

## 🔄 LIFF初期化フロー（詳細）

```
┌──────────────────────────────────────────────────────────────────┐
│ LIFFページが開かれた瞬間の処理フロー                              │
└──────────────────────────────────────────────────────────────────┘

ユーザーがリッチメニューをタップ
         │
         ▼
┌────────────────────────────────────┐
│ 1. ページ読み込み開始               │
│    URL: /liff/booking/salon-a      │
└────────────────┬───────────────────┘
                 │
                 ▼
┌────────────────────────────────────┐
│ 2. React マウント                  │
│    useEffect() 実行                │
└────────────────┬───────────────────┘
                 │
                 ▼
┌────────────────────────────────────┐
│ 3. 組織のLIFF ID取得               │
│                                    │
│    Supabase Query:                │
│    SELECT liff_id                 │
│    FROM organizations             │
│    WHERE slug = 'salon-a'         │
└────────────────┬───────────────────┘
                 │
                 ▼
┌────────────────────────────────────┐
│ 4. LIFF SDK 初期化                 │
│                                    │
│    await liff.init({              │
│      liffId: '1234567890-abcd'    │
│    })                             │
└────────────────┬───────────────────┘
                 │
                 ▼
         ┌───────────────┐
         │ログイン済み？  │
         └───┬───────┬───┘
             │ No    │ Yes
             ▼       ▼
    ┌────────────┐  ┌────────────────────────┐
    │LINE        │  │ 5. プロフィール取得     │
    │ログイン画面│  │                         │
    │を表示      │  │    profile =            │
    │            │  │    await liff.          │
    │[ログイン]  │  │    getProfile()         │
    │ボタン      │  │                         │
    └─────┬──────┘  └───────┬────────────────┘
          │                 │
          │ ログイン完了     │
          │ (リダイレクト)   │
          │                 │
          └────────┬────────┘
                   ▼
┌──────────────────────────────────────────┐
│ 6. 顧客情報の取得または作成               │
│                                          │
│    Step 1: LINE User IDで検索           │
│    ┌────────────────────────────────┐   │
│    │ SELECT * FROM customers        │   │
│    │ WHERE line_user_id = 'U123...' │   │
│    └────────┬───────────────────────┘   │
│             │                            │
│      ┌──────┴──────┐                    │
│      │見つかった？  │                    │
│      └──┬───────┬──┘                    │
│    Yes  │       │ No                    │
│         ▼       ▼                       │
│  ┌──────────┐ ┌──────────────────┐     │
│  │既存顧客  │ │Step 2: 新規作成   │     │
│  │情報取得  │ │                   │     │
│  │          │ │ INSERT INTO       │     │
│  │email:    │ │ customers         │     │
│  │phone:    │ │ (line_user_id,    │     │
│  │address:  │ │  name,            │     │
│  │などを    │ │  organization_id) │     │
│  │取得      │ │                   │     │
│  └────┬─────┘ └────────┬─────────┘     │
│       └──────────┬──────┘               │
└──────────────────┼──────────────────────┘
                   ▼
┌──────────────────────────────────────────┐
│ 7. フォームに初期値をセット               │
│                                          │
│    BookingCustomerForm に渡すデータ:     │
│    {                                     │
│      name: "山田太郎",                   │
│      email: "yamada@example.com",       │
│      phone: "090-1234-5678",            │
│      address: "東京都...",              │
│      postal_code: "123-4567"            │
│    }                                     │
└──────────────────┬───────────────────────┘
                   ▼
┌──────────────────────────────────────────┐
│ 8. 予約フォーム表示                       │
│                                          │
│    ✅ 初期化完了                         │
│    ✅ ローディング画面を非表示            │
│    ✅ 予約フォームを表示                  │
└──────────────────────────────────────────┘
```

---

## 📊 データフロー図

```
┌─────────────────────────────────────────────────────────────────┐
│           Web予約 vs LINE予約のデータフロー比較                  │
└─────────────────────────────────────────────────────────────────┘

Web予約
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. ユーザーがフォームに手入力
   ┌─────────────────────────┐
   │ name: "山田太郎"         │  ← 手入力
   │ email: "yamada@..."     │  ← 手入力
   │ phone: "090-..."        │  ← 手入力
   └───────────┬─────────────┘
               │
               ▼
2. 予約データ作成
   ┌─────────────────────────┐
   │ POST /bookings          │
   │ {                       │
   │   customer_id: null,    │  ← 新規顧客
   │   customer_name: "...", │
   │   customer_email: "..." │
   │ }                       │
   └───────────┬─────────────┘
               │
               ▼
3. customers テーブルに新規作成
   ┌─────────────────────────┐
   │ id: uuid-123            │
   │ name: "山田太郎"        │
   │ email: "yamada@..."     │
   │ phone: "090-..."        │
   │ line_user_id: NULL      │  ← LINEと紐付いていない
   └───────────┬─────────────┘
               │
               ▼
4. bookings テーブルに保存
   ┌─────────────────────────┐
   │ customer_id: uuid-123   │  ← 上で作成したID
   │ total_price: 5000       │
   │ status: "pending"       │
   └─────────────────────────┘


LINE予約
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. LIFF経由で自動取得
   ┌─────────────────────────┐
   │ liff.getProfile()       │
   │ ↓                       │
   │ userId: "U123abc..."    │  ← LINE固有ID
   │ displayName: "山田太郎" │  ← 自動取得
   │ pictureUrl: "https://..." │
   └───────────┬─────────────┘
               │
               ▼
2. 既存顧客を検索
   ┌─────────────────────────────────┐
   │ SELECT * FROM customers         │
   │ WHERE line_user_id = 'U123...'  │
   └────────┬──────────────────┬─────┘
            │ 見つかった       │ 見つからない
            ▼                  ▼
   ┌────────────────┐  ┌──────────────────┐
   │既存顧客データ  │  │新規顧客作成      │
   │を取得          │  │                  │
   │                │  │ INSERT INTO      │
   │id: uuid-999    │  │ customers        │
   │name: "山田太郎"│  │ (line_user_id,   │
   │email: "..."    │  │  name, ...)      │
   │phone: "..."    │  │                  │
   │line_user_id:   │  │ ↓                │
   │  "U123..."     │  │ id: uuid-888     │
   └────────┬───────┘  └────────┬─────────┘
            └──────────┬────────┘
                       ▼
3. フォームに自動入力
   ┌─────────────────────────┐
   │ name: "山田太郎"         │  ← 自動セット
   │ email: "yamada@..."     │  ← 自動セット
   │ phone: "090-..."        │  ← 自動セット
   └───────────┬─────────────┘
               │ ユーザーは確認するだけ
               ▼
4. 予約データ作成
   ┌─────────────────────────┐
   │ POST /bookings          │
   │ {                       │
   │   customer_id: uuid-999,│  ← 既存ID
   │   ...                   │
   │ }                       │
   └───────────┬─────────────┘
               │
               ▼
5. bookings テーブルに保存
   ┌─────────────────────────┐
   │ customer_id: uuid-999   │  ← LINE連携済み顧客
   │ total_price: 5000       │
   │ status: "pending"       │
   └───────────┬─────────────┘
               │
               ▼
6. LINE通知送信
   ┌─────────────────────────┐
   │ send-hybrid-notification│
   │ ↓                       │
   │ LINE Messaging API      │
   │ ↓                       │
   │ ユーザーのLINEに届く    │
   └─────────────────────────┘
```

---

## 🗂️ ファイル構成図

```
/Users/ayumu/HaukuriPro1-24/
│
├─ src/
│  ├─ pages/
│  │  ├─ BookingPage.tsx                    ← Web予約ページ（既存）
│  │  │
│  │  └─ liff/                              ← 新規作成
│  │     ├─ LiffBookingPage.tsx             ← LINE予約ページ ★新規★
│  │     └─ MyBookingsPage.tsx              ← 予約確認（既存）
│  │
│  ├─ components/
│  │  ├─ booking/                           ← 共通コンポーネント
│  │  │  ├─ BookingServiceSelection.tsx    ← 再利用
│  │  │  ├─ BookingDateTimeSelection.tsx   ← 再利用
│  │  │  ├─ BookingCustomerForm.tsx        ← 再利用
│  │  │  └─ BookingConfirmation.tsx        ← 再利用
│  │  │
│  │  └─ liff/                              ← LIFF専用コンポーネント
│  │     ├─ LiffHeader.tsx                  ★新規★
│  │     ├─ LiffLoadingScreen.tsx           ★新規★
│  │     └─ LiffCompleteScreen.tsx          ★新規★
│  │
│  ├─ hooks/
│  │  ├─ useBooking.ts                      ← 既存（共通）
│  │  └─ useLiff.ts                         ★新規★
│  │
│  └─ lib/
│     └─ liff.ts                             ★新規★
│
├─ supabase/
│  ├─ functions/
│  │  ├─ send-hybrid-notification/          ← 既存（拡張）
│  │  │  └─ index.ts
│  │  │
│  │  └─ get-or-create-customer/            ★新規★
│  │     └─ index.ts
│  │
│  └─ migrations/
│     └─ 20240301000000_ensure_line_user_id.sql  ← 確認用
│
└─ package.json
   └─ dependencies:
      └─ @line/liff: "^2.23.0"               ★追加★
```

---

## 🔐 セキュリティとRLS図

```
┌─────────────────────────────────────────────────────────────────┐
│               Row Level Security (RLS) の動作                     │
└─────────────────────────────────────────────────────────────────┘

Web予約（認証なし）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ブラウザ → Supabase
           ├─ anon key使用
           └─ auth.uid() = NULL

customers テーブル
┌────────────────────────────────────┐
│ RLS Policy:                        │
│ CREATE POLICY "public_insert"      │
│ ON customers FOR INSERT            │
│ TO anon                            │  ← 匿名ユーザーでもINSERT可能
│ WITH CHECK (true);                 │
└────────────────────────────────────┘

bookings テーブル
┌────────────────────────────────────┐
│ RLS Policy:                        │
│ CREATE POLICY "public_insert"      │
│ ON bookings FOR INSERT             │
│ TO anon                            │  ← 匿名ユーザーでもINSERT可能
│ WITH CHECK (true);                 │
└────────────────────────────────────┘


LINE予約（LIFF）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

LINEアプリ → LIFF → Supabase
                    ├─ anon key使用
                    └─ auth.uid() = NULL  ← 同じ

問題: LINE User IDをどう信頼する？
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ 悪い方法: クライアントから直接送信
   ┌─────────────────────────────────┐
   │ フロントエンド                   │
   │ const profile =                 │
   │   await liff.getProfile();      │
   │                                 │
   │ supabase.from('customers')      │
   │   .insert({                     │
   │     line_user_id: profile.userId │  ← 改ざん可能！
   │   })                            │
   └─────────────────────────────────┘

✅ 良い方法: Supabase Function経由
   ┌─────────────────────────────────┐
   │ フロントエンド                   │
   │ const profile =                 │
   │   await liff.getProfile();      │
   │                                 │
   │ const idToken =                 │
   │   liff.getIDToken();            │  ← LINE発行のJWT
   │                                 │
   │ supabase.functions.invoke(      │
   │   'get-or-create-customer',     │
   │   {                             │
   │     body: { idToken }           │  ← JWTトークンを送信
   │   }                             │
   │ )                               │
   └────────────┬────────────────────┘
                │
                ▼
   ┌─────────────────────────────────┐
   │ Supabase Function               │
   │ (サーバーサイド)                 │
   │                                 │
   │ 1. idTokenを検証                │
   │    LINE APIで署名チェック        │
   │                                 │
   │ 2. 検証成功したら               │
   │    line_user_idを信頼           │
   │                                 │
   │ 3. SECURITY DEFINER権限で       │
   │    RLSをバイパスして             │
   │    顧客作成                     │
   │                                 │
   │    INSERT INTO customers        │
   │    (line_user_id, ...)          │
   │    VALUES (verified_user_id, ...)│
   └─────────────────────────────────┘
```

---

## 📱 ユーザージャーニー図

```
┌─────────────────────────────────────────────────────────────────┐
│                  Web予約のユーザージャーニー                      │
└─────────────────────────────────────────────────────────────────┘

時間軸 →

0:00  Google検索
      「近くの美容室 予約」
        │
        ▼
0:30  店舗サイトを発見
      URLをクリック
        │
        ▼
1:00  サイト閲覧
      サービス内容確認
        │
        ▼
2:00  「予約する」ボタン発見
      クリック
        │
        ▼
2:10  予約ページ表示
      ┌─────────────────┐
      │ サービス選択    │
      │ ☐ カット        │
      │ ☐ カラー        │
      └─────────────────┘
        │ 選択
        ▼
3:00  日時選択
      カレンダーで選択
        │
        ▼
4:00  顧客情報入力 ← ここで離脱が多い
      ┌─────────────────┐
      │ 名前: ＿＿＿    │  手入力
      │ メール: ＿＿   │  手入力
      │ 電話: ＿＿＿   │  手入力
      │ 住所: ＿＿＿   │  手入力
      └─────────────────┘
        │ 入力に5分
        ▼
9:00  確認画面
      内容チェック
        │
        ▼
9:30  予約完了
      ┌─────────────────┐
      │ 完了！          │
      │ メールを送信    │
      │ しました        │
      └─────────────────┘
        │
        ▼
10:00 タブを閉じる
        │
        ▼
30分後 メールをチェック
      確認書を確認

総所要時間: 約10分
離脱ポイント: 顧客情報入力（入力が面倒）


┌─────────────────────────────────────────────────────────────────┐
│                  LINE予約のユーザージャーニー                     │
└─────────────────────────────────────────────────────────────────┘

時間軸 →

0:00  LINEを開く
      （日常的な行動）
        │
        ▼
0:05  リッチメニューを見る
      ┌─────────────────┐
      │ 予約する 🗓️     │ ← タップ
      └─────────────────┘
        │
        ▼
0:10  LIFFページが開く
      （1秒で起動）
        │
        ▼
0:15  予約ページ表示
      ┌─────────────────┐
      │ 山田太郎 様      │ ← 既に表示されている
      │                 │
      │ サービス選択    │
      │ ☐ カット        │
      │ ☐ カラー        │
      └─────────────────┘
        │ 選択
        ▼
1:00  日時選択
      カレンダーで選択
        │
        ▼
2:00  顧客情報確認 ← 入力済み！
      ┌─────────────────┐
      │ 名前: 山田太郎  │ ✅ 自動入力
      │ メール: yamada@...│ ✅ 自動入力
      │ 電話: 090-...   │ ✅ 自動入力
      │ 住所: 東京都... │ ✅ 自動入力
      └─────────────────┘
        │ 確認だけ（5秒）
        ▼
2:05  確認画面
      内容チェック
        │
        ▼
2:30  予約完了
      ┌─────────────────┐
      │ 完了！          │
      │ [LINEに戻る]    │ ← タップ
      └─────────────────┘
        │
        ▼
2:35  LINEトーク画面に戻る
        │ すぐに通知が届く
        ▼
      ┌─────────────────┐
      │ 🔔 新着メッセージ│
      │                 │
      │ 予約完了 ✅     │
      │ 2024/03/15 14:00│
      │ カット ¥5,000   │
      └─────────────────┘

総所要時間: 約2分30秒
離脱ポイント: ほぼなし（入力が不要）

改善効果: 所要時間 75%減、離脱率 50%減
```

---

## 🎨 UI/UX比較図

```
┌─────────────────────────────────────────────────────────────────┐
│                    画面レイアウト比較                             │
└─────────────────────────────────────────────────────────────────┘

Web予約                            LINE予約（LIFF）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────┐          ┌─────────────────────┐
│ https://domain.com/ │          │ ✕                   │ ← 閉じるボタン
│ booking/salon-a     │          ├─────────────────────┤
├─────────────────────┤          │ 👤 山田太郎 様      │
│                     │          │    ご予約手続き      │
│  〇〇サロン          │          ├─────────────────────┤
│  予約システム        │          │                     │
│                     │          │ ●━━○━━○━━○        │
│ [ホーム][店舗情報]  │          │ 1  2  3  4         │
├─────────────────────┤          │ サービス 日時 情報 確認│
│                     │          ├─────────────────────┤
│ ●━━○━━○━━○        │          │                     │
│ 1  2  3  4         │          │ サービス選択         │
│                     │          │                     │
├─────────────────────┤          │ ☐ カット            │
│                     │          │ ☐ カラー            │
│ サービス選択         │          │ ☐ パーマ            │
│                     │          │                     │
│ ☐ カット            │          │                     │
│ ☐ カラー            │          │                     │
│ ☐ パーマ            │          │                     │
│                     │          │                     │
│                     │          │ [次へ →]            │
│                     │          │                     │
│                     │          └─────────────────────┘
│ [次へ →]            │
│                     │          特徴:
│                     │          ✅ URLバーなし
├─────────────────────┤          ✅ ユーザー名表示
│ © 2024 〇〇サロン    │          ✅ 進捗バーがシンプル
│ [利用規約]          │          ✅ アプリっぽいUI
│ [プライバシー]      │          ✅ フッター最小限
└─────────────────────┘

特徴:
- 通常のWebサイト
- ナビゲーション豊富
- フッター充実


顧客情報画面
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Web予約                            LINE予約（LIFF）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────┐          ┌─────────────────────┐
│ 顧客情報入力         │          │ ✕                   │
├─────────────────────┤          ├─────────────────────┤
│                     │          │ 👤 🖼️ 山田太郎 様   │
│ お名前 *            │          │    ご予約手続き      │
│ ┌─────────────────┐│          ├─────────────────────┤
│ │                 ││          │ 顧客情報確認         │
│ └─────────────────┘│          ├─────────────────────┤
│   ↑ 空欄           │          │                     │
│                     │          │ お名前 *            │
│ メールアドレス *     │          │ ┌─────────────────┐│
│ ┌─────────────────┐│          │ │ 山田太郎         ││ ✅
│ │                 ││          │ └─────────────────┘│
│ └─────────────────┘│          │   ↑ 自動入力        │
│   ↑ 空欄           │          │                     │
│                     │          │ メールアドレス *     │
│ 電話番号 *          │          │ ┌─────────────────┐│
│ ┌─────────────────┐│          │ │ yamada@...       ││ ✅
│ │                 ││          │ └─────────────────┘│
│ └─────────────────┘│          │   ↑ 過去データから  │
│   ↑ 空欄           │          │                     │
│                     │          │ 電話番号 *          │
│ 住所                │          │ ┌─────────────────┐│
│ ┌─────────────────┐│          │ │ 090-1234-5678    ││ ✅
│ │                 ││          │ └─────────────────┘│
│ └─────────────────┘│          │   ↑ 過去データから  │
│   ↑ 空欄           │          │                     │
│                     │          │ 住所                │
│                     │          │ ┌─────────────────┐│
│ [← 戻る] [次へ →]  │          │ │ 東京都...        ││ ✅
│                     │          │ └─────────────────┘│
└─────────────────────┘          │   ↑ 過去データから  │
                                 │                     │
所要時間: 5分                     │ [← 戻る] [次へ →]  │
                                 │                     │
                                 └─────────────────────┘

                                 所要時間: 5秒（確認のみ）


完了画面
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Web予約                            LINE予約（LIFF）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────┐          ┌─────────────────────┐
│                     │          │ ✕                   │
│      ✅             │          ├─────────────────────┤
│                     │          │                     │
│   予約完了！         │          │      ✅             │
│                     │          │                     │
│ 確認メールを送信     │          │   予約完了！         │
│ しました            │          │                     │
│                     │          │ LINEでメッセージを   │
│ 後ほどメールを       │          │ お送りしました       │
│ ご確認ください       │          │                     │
│                     │          │                     │
│                     │          │                     │
│ ┌─────────────────┐│          │ ┌─────────────────┐│
│ │ 予約一覧へ       ││          │ │ LINEに戻る       ││
│ └─────────────────┘│          │ └─────────────────┘│
│                     │          │                     │
│ ┌─────────────────┐│          │ ※この画面を閉じると │
│ │ トップページへ   ││          │   LINEトーク画面で   │
│ └─────────────────┘│          │   確認メッセージが   │
│                     │          │   表示されます       │
└─────────────────────┘          └─────────────────────┘
        │                                │
        ▼                                ▼
 ユーザーがタブを閉じる            [LINEに戻る]をタップ
        │                                │
        ▼                                ▼
   何もなし                      ┌─────────────────────┐
                                 │ LINEトーク画面       │
                                 ├─────────────────────┤
                                 │ 🔔 新着メッセージ    │
                                 │                     │
                                 │ 予約完了 ✅         │
                                 │                     │
                                 │ 山田太郎 様          │
                                 │ ご予約ありがとう     │
                                 │ ございます           │
                                 │                     │
                                 │ 日時: 2024/03/15    │
                                 │       14:00         │
                                 │ サービス: カット     │
                                 │ 料金: ¥5,000        │
                                 │                     │
                                 │ [予約詳細を見る]    │
                                 │ [日程を変更する]    │
                                 └─────────────────────┘
```

この図解で、LINE予約実装の全体像が理解できたと思います。何か特定の部分について詳しく知りたいことがあれば教えてください！
